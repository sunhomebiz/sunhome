var __extends=this.__extends||function(b,a){function e(){this.constructor=b}for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);e.prototype=a.prototype;b.prototype=new e},MutationObserverCtor;MutationObserverCtor="undefined"!==typeof WebKitMutationObserver?WebKitMutationObserver:MutationObserver;
var NodeMap=function(){function b(){this.nodes=[];this.values=[]}b.prototype.isIndex=function(a){return+a===a>>>0};b.prototype.nodeId=function(a){var e=a[b.ID_PROP];e||(e=a[b.ID_PROP]=b.nextId_++);return e};b.prototype.set=function(a,e){var c=this.nodeId(a);this.nodes[c]=a;this.values[c]=e};b.prototype.get=function(a){a=this.nodeId(a);return this.values[a]};b.prototype.has=function(a){return this.nodeId(a)in this.nodes};b.prototype["delete"]=function(a){a=this.nodeId(a);delete this.nodes[a];this.values[a]=
void 0};b.prototype.keys=function(){var a=[],e;for(e in this.nodes)this.isIndex(e)&&a.push(this.nodes[e]);return a};b.ID_PROP="__mutation_summary_node_map_id__";b.nextId_=1;return b}(),Movement;(function(b){b[b.STAYED_OUT=0]="STAYED_OUT";b[b.ENTERED=1]="ENTERED";b[b.STAYED_IN=2]="STAYED_IN";b[b.REPARENTED=3]="REPARENTED";b[b.REORDERED=4]="REORDERED";b[b.EXITED=5]="EXITED"})(Movement||(Movement={}));function enteredOrExited(b){return 1===b||5===b}
var NodeChange=function(){function b(a,e,c,d,g,b,k,m){"undefined"===typeof e&&(e=!1);"undefined"===typeof c&&(c=!1);"undefined"===typeof d&&(d=!1);"undefined"===typeof g&&(g=null);"undefined"===typeof b&&(b=!1);"undefined"===typeof k&&(k=null);"undefined"===typeof m&&(m=null);this.node=a;this.childList=e;this.attributes=c;this.characterData=d;this.oldParentNode=g;this.added=b;this.attributeOldValues=k;this.characterDataOldValue=m;this.isCaseInsensitive=this.node.nodeType===Node.ELEMENT_NODE&&this.node instanceof
HTMLElement&&this.node.ownerDocument instanceof HTMLDocument}b.prototype.getAttributeOldValue=function(a){if(this.attributeOldValues)return this.isCaseInsensitive&&(a=a.toLowerCase()),this.attributeOldValues[a]};b.prototype.getAttributeNamesMutated=function(){var a=[];if(!this.attributeOldValues)return a;for(var e in this.attributeOldValues)a.push(e);return a};b.prototype.attributeMutated=function(a,e){this.attributes=!0;this.attributeOldValues=this.attributeOldValues||{};a in this.attributeOldValues||
(this.attributeOldValues[a]=e)};b.prototype.characterDataMutated=function(a){this.characterData||(this.characterData=!0,this.characterDataOldValue=a)};b.prototype.removedFromParent=function(a){this.childList=!0;this.added||this.oldParentNode?this.added=!1:this.oldParentNode=a};b.prototype.insertedIntoParent=function(){this.added=this.childList=!0};b.prototype.getOldParent=function(){if(this.childList){if(this.oldParentNode)return this.oldParentNode;if(this.added)return null}return this.node.parentNode};
return b}(),ChildListChange=function(){return function(){this.added=new NodeMap;this.removed=new NodeMap;this.maybeMoved=new NodeMap;this.oldPrevious=new NodeMap;this.moved=void 0}}(),TreeChanges=function(b){function a(a,c){b.call(this);this.rootNode=a;this.wasReachableCache=this.reachableCache=void 0;this.anyCharacterDataChanged=this.anyAttributesChanged=this.anyParentsChanged=!1;for(var d=0;d<c.length;d++){var g=c[d];switch(g.type){case "childList":this.anyParentsChanged=!0;for(var f=0;f<g.removedNodes.length;f++){var k=
g.removedNodes[f];this.getChange(k).removedFromParent(g.target)}for(f=0;f<g.addedNodes.length;f++)k=g.addedNodes[f],this.getChange(k).insertedIntoParent();break;case "attributes":this.anyAttributesChanged=!0;f=this.getChange(g.target);f.attributeMutated(g.attributeName,g.oldValue);break;case "characterData":this.anyCharacterDataChanged=!0,f=this.getChange(g.target),f.characterDataMutated(g.oldValue)}}}__extends(a,b);a.prototype.getChange=function(a){var c=this.get(a);c||(c=new NodeChange(a),this.set(a,
c));return c};a.prototype.getOldParent=function(a){var c=this.get(a);return c?c.getOldParent():a.parentNode};a.prototype.getIsReachable=function(a){if(a===this.rootNode)return!0;if(!a)return!1;this.reachableCache=this.reachableCache||new NodeMap;var c=this.reachableCache.get(a);void 0===c&&(c=this.getIsReachable(a.parentNode),this.reachableCache.set(a,c));return c};a.prototype.getWasReachable=function(a){if(a===this.rootNode)return!0;if(!a)return!1;this.wasReachableCache=this.wasReachableCache||new NodeMap;
var c=this.wasReachableCache.get(a);void 0===c&&(c=this.getWasReachable(this.getOldParent(a)),this.wasReachableCache.set(a,c));return c};a.prototype.reachabilityChange=function(a){return this.getIsReachable(a)?this.getWasReachable(a)?2:1:this.getWasReachable(a)?5:0};return a}(NodeMap),MutationProjection=function(){function b(a,e,c,d,g){this.rootNode=a;this.mutations=e;this.selectors=c;this.calcReordered=d;this.calcOldPreviousSibling=g;this.treeChanges=new TreeChanges(a,e);this.entered=[];this.exited=
[];this.stayedIn=new NodeMap;this.visited=new NodeMap;this.matchCache=this.characterDataOnly=this.childListChangeMap=void 0;this.processMutations()}b.prototype.processMutations=function(){if(this.treeChanges.anyParentsChanged||this.treeChanges.anyAttributesChanged)for(var a=this.treeChanges.keys(),e=0;e<a.length;e++)this.visitNode(a[e],void 0)};b.prototype.visitNode=function(a,e){if(!this.visited.has(a)){this.visited.set(a,!0);var c=this.treeChanges.get(a),d=e;if(c&&c.childList||void 0==d)d=this.treeChanges.reachabilityChange(a);
if(0!==d){this.matchabilityChange(a);if(1===d)this.entered.push(a);else if(5===d)this.exited.push(a),this.ensureHasOldPreviousSiblingIfNeeded(a);else if(2===d){var g=2;c&&c.childList&&(c.oldParentNode!==a.parentNode?(g=3,this.ensureHasOldPreviousSiblingIfNeeded(a)):this.calcReordered&&this.wasReordered(a)&&(g=4));this.stayedIn.set(a,g)}if(2!==d)for(c=a.firstChild;c;c=c.nextSibling)this.visitNode(c,d)}}};b.prototype.ensureHasOldPreviousSiblingIfNeeded=function(a){if(this.calcOldPreviousSibling){this.processChildlistChanges();
var e=a.parentNode,c=this.treeChanges.get(a);c&&c.oldParentNode&&(e=c.oldParentNode);c=this.childListChangeMap.get(e);c||(c=new ChildListChange,this.childListChangeMap.set(e,c));c.oldPrevious.has(a)||c.oldPrevious.set(a,a.previousSibling)}};b.prototype.getChanged=function(a,e,c){this.selectors=e;this.characterDataOnly=c;for(e=0;e<this.entered.length;e++){c=this.entered[e];var d=this.matchabilityChange(c);1!==d&&2!==d||a.added.push(c)}var g=this.stayedIn.keys();for(e=0;e<g.length;e++)c=g[e],d=this.matchabilityChange(c),
1===d?a.added.push(c):5===d?a.removed.push(c):2===d&&(a.reparented||a.reordered)&&(d=this.stayedIn.get(c),a.reparented&&3===d?a.reparented.push(c):a.reordered&&4===d&&a.reordered.push(c));for(e=0;e<this.exited.length;e++)c=this.exited[e],d=this.matchabilityChange(c),5!==d&&2!==d||a.removed.push(c)};b.prototype.getOldParentNode=function(a){var e=this.treeChanges.get(a);if(e&&e.childList)return e.oldParentNode?e.oldParentNode:null;e=this.treeChanges.reachabilityChange(a);if(0===e||1===e)throw Error("getOldParentNode requested on invalid node.");
return a.parentNode};b.prototype.getOldPreviousSibling=function(a){var e=a.parentNode,c=this.treeChanges.get(a);c&&c.oldParentNode&&(e=c.oldParentNode);e=this.childListChangeMap.get(e);if(!e)throw Error("getOldPreviousSibling requested on invalid node.");return e.oldPrevious.get(a)};b.prototype.getOldAttribute=function(a,e){var c=this.treeChanges.get(a);if(!c||!c.attributes)throw Error("getOldAttribute requested on invalid node.");c=c.getAttributeOldValue(e);if(void 0===c)throw Error("getOldAttribute requested for unchanged attribute name.");
return c};b.prototype.attributeChangedNodes=function(a){if(!this.treeChanges.anyAttributesChanged)return{};var e,c;if(a){e={};c={};for(var d=0;d<a.length;d++){var g=a[d];e[g]=!0;c[g.toLowerCase()]=g}}a={};for(var b=this.treeChanges.keys(),d=0;d<b.length;d++){var g=b[d],k=this.treeChanges.get(g);if(k.attributes&&2===this.treeChanges.reachabilityChange(g)&&2===this.matchabilityChange(g))for(var m=g,l=k.getAttributeNamesMutated(),n=0;n<l.length;n++)g=l[n],(!e||e[g]||k.isCaseInsensitive&&c[g])&&k.getAttributeOldValue(g)!==
m.getAttribute(g)&&(c&&k.isCaseInsensitive&&(g=c[g]),a[g]=a[g]||[],a[g].push(m))}return a};b.prototype.getOldCharacterData=function(a){a=this.treeChanges.get(a);if(!a||!a.characterData)throw Error("getOldCharacterData requested on invalid node.");return a.characterDataOldValue};b.prototype.getCharacterDataChanged=function(){if(!this.treeChanges.anyCharacterDataChanged)return[];for(var a=this.treeChanges.keys(),e=[],c=0;c<a.length;c++){var d=a[c];if(2===this.treeChanges.reachabilityChange(d)){var b=
this.treeChanges.get(d);b.characterData&&d.textContent!=b.characterDataOldValue&&e.push(d)}}return e};b.prototype.computeMatchabilityChange=function(a,e){this.matchCache||(this.matchCache=[]);this.matchCache[a.uid]||(this.matchCache[a.uid]=new NodeMap);var c=this.matchCache[a.uid],d=c.get(e);void 0===d&&(d=a.matchabilityChange(e,this.treeChanges.get(e)),c.set(e,d));return d};b.prototype.matchabilityChange=function(a){var e=this;if(this.characterDataOnly)switch(a.nodeType){case Node.COMMENT_NODE:case Node.TEXT_NODE:return 2;
default:return 0}if(!this.selectors)return 2;if(a.nodeType!==Node.ELEMENT_NODE)return 0;for(var c=this.selectors.map(function(c){return e.computeMatchabilityChange(c,a)}),d=0,b=0;2!==d&&b<c.length;){switch(c[b]){case 2:d=2;break;case 1:d=5===d?2:1;break;case 5:d=1===d?2:5}b++}return d};b.prototype.getChildlistChange=function(a){var e=this.childListChangeMap.get(a);e||(e=new ChildListChange,this.childListChangeMap.set(a,e));return e};b.prototype.processChildlistChanges=function(){if(!this.childListChangeMap){this.childListChangeMap=
new NodeMap;for(var a=0;a<this.mutations.length;a++){var e=function(a,c){!a||d.oldPrevious.has(a)||d.added.has(a)||d.maybeMoved.has(a)||c&&(d.added.has(c)||d.maybeMoved.has(c))||d.oldPrevious.set(a,c)},c=this.mutations[a];if("childList"==c.type&&(2===this.treeChanges.reachabilityChange(c.target)||this.calcOldPreviousSibling)){for(var d=this.getChildlistChange(c.target),b=c.previousSibling,f=0;f<c.removedNodes.length;f++){var k=c.removedNodes[f];e(k,b);d.added.has(k)?d.added["delete"](k):(d.removed.set(k,
!0),d.maybeMoved["delete"](k));b=k}e(c.nextSibling,b);for(f=0;f<c.addedNodes.length;f++)k=c.addedNodes[f],d.removed.has(k)?(d.removed["delete"](k),d.maybeMoved.set(k,!0)):d.added.set(k,!0)}}}};b.prototype.wasReordered=function(a){function e(a){if(!a||!f.maybeMoved.has(a))return!1;var b=f.moved.get(a);if(void 0!==b)return b;if(k.has(a))b=!0;else{k.set(a,!0);if(l.has(a))b=l.get(a);else{for(b=a.previousSibling;b&&(f.added.has(b)||e(b));)b=b.previousSibling;l.set(a,b)}b=b!==c(a)}k.has(a)?(k["delete"](a),
f.moved.set(a,b)):b=f.moved.get(a);return b}function c(a){var b=m.get(a);if(void 0!==b)return b;for(b=f.oldPrevious.get(a);b&&(f.removed.has(b)||e(b));)b=c(b);void 0===b&&(b=a.previousSibling);m.set(a,b);return b}if(!this.treeChanges.anyParentsChanged)return!1;this.processChildlistChanges();var d=a.parentNode,b=this.treeChanges.get(a);b&&b.oldParentNode&&(d=b.oldParentNode);var f=this.childListChangeMap.get(d);if(!f)return!1;if(f.moved)return f.moved.get(a);f.moved=new NodeMap;var k=new NodeMap,m=
new NodeMap,l=new NodeMap;f.maybeMoved.keys().forEach(e);return f.moved.get(a)};return b}(),Summary=function(){function b(a,b){var c=this;this.projection=a;this.added=[];this.removed=[];this.reparented=b.all||b.element?[]:void 0;this.reordered=b.all?[]:void 0;a.getChanged(this,b.elementFilter,b.characterData);if(b.all||b.attribute||b.attributeList){var d=a.attributeChangedNodes(b.attribute?[b.attribute]:b.attributeList);b.attribute?this.valueChanged=d[b.attribute]||[]:(this.attributeChanged=d,b.attributeList&&
b.attributeList.forEach(function(a){c.attributeChanged.hasOwnProperty(a)||(c.attributeChanged[a]=[])}))}if(b.all||b.characterData)d=a.getCharacterDataChanged(),b.characterData?this.valueChanged=d:this.characterDataChanged=d;this.reordered&&(this.getOldPreviousSibling=a.getOldPreviousSibling.bind(a))}b.prototype.getOldParentNode=function(a){return this.projection.getOldParentNode(a)};b.prototype.getOldAttribute=function(a,b){return this.projection.getOldAttribute(a,b)};b.prototype.getOldCharacterData=
function(a){return this.projection.getOldCharacterData(a)};b.prototype.getOldPreviousSibling=function(a){return this.projection.getOldPreviousSibling(a)};return b}(),validNameInitialChar=/[a-zA-Z_]+/,validNameNonInitialChar=/[a-zA-Z0-9_\-]+/;function escapeQuotes(b){return'"'+b.replace(/"/,'\\"')+'"'}
var Qualifier=function(){function b(){}b.prototype.matches=function(a){if(null===a)return!1;if(void 0===this.attrValue)return!0;if(!this.contains)return this.attrValue==a;a=a.split(" ");for(var b=0;b<a.length;b++)if(this.attrValue===a[b])return!0;return!1};b.prototype.toString=function(){return"class"===this.attrName&&this.contains?"."+this.attrValue:"id"!==this.attrName||this.contains?this.contains?"["+this.attrName+"~="+escapeQuotes(this.attrValue)+"]":"attrValue"in this?"["+this.attrName+"="+escapeQuotes(this.attrValue)+
"]":"["+this.attrName+"]":"#"+this.attrValue};return b}(),Selector=function(){function b(){this.uid=b.nextUid++;this.qualifiers=[]}Object.defineProperty(b.prototype,"caseInsensitiveTagName",{get:function(){return this.tagName.toUpperCase()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"selectorString",{get:function(){return this.tagName+this.qualifiers.join("")},enumerable:!0,configurable:!0});b.prototype.isMatching=function(a){return a[b.matchesSelector](this.selectorString)};
b.prototype.wasMatching=function(a,b,c){if(!b||!b.attributes)return c;var d=b.isCaseInsensitive?this.caseInsensitiveTagName:this.tagName;if("*"!==d&&d!==a.tagName)return!1;for(var d=[],g=!1,f=0;f<this.qualifiers.length;f++){var k=this.qualifiers[f],m=b.getAttributeOldValue(k.attrName);d.push(m);g=g||void 0!==m}if(!g)return c;for(f=0;f<this.qualifiers.length;f++)if(k=this.qualifiers[f],m=d[f],void 0===m&&(m=a.getAttribute(k.attrName)),!k.matches(m))return!1;return!0};b.prototype.matchabilityChange=
function(a,b){var c=this.isMatching(a);return c?this.wasMatching(a,b,c)?2:1:this.wasMatching(a,b,c)?5:0};b.parseSelectors=function(a){function e(){g&&(f&&(g.qualifiers.push(f),f=void 0),d.push(g));g=new b}function c(){f&&g.qualifiers.push(f);f=new Qualifier}for(var d=[],g,f,k=/\s/,m,l=1,n=0;n<a.length;){var h=a[n++];switch(l){case 1:if(h.match(validNameInitialChar)){e();g.tagName=h;l=2;break}if("*"==h){e();g.tagName="*";l=3;break}if("."==h){e();c();g.tagName="*";f.attrName="class";f.contains=!0;l=
4;break}if("#"==h){e();c();g.tagName="*";f.attrName="id";l=4;break}if("["==h){e();c();g.tagName="*";f.attrName="";l=6;break}if(h.match(k))break;throw Error("Invalid or unsupported selector syntax.");case 2:if(h.match(validNameNonInitialChar)){g.tagName+=h;break}if("."==h){c();f.attrName="class";f.contains=!0;l=4;break}if("#"==h){c();f.attrName="id";l=4;break}if("["==h){c();f.attrName="";l=6;break}if(h.match(k)){l=14;break}if(","==h){l=1;break}throw Error("Invalid or unsupported selector syntax.");
case 3:if("."==h){c();f.attrName="class";f.contains=!0;l=4;break}if("#"==h){c();f.attrName="id";l=4;break}if("["==h){c();f.attrName="";l=6;break}if(h.match(k)){l=14;break}if(","==h){l=1;break}throw Error("Invalid or unsupported selector syntax.");case 4:if(h.match(validNameInitialChar)){f.attrValue=h;l=5;break}throw Error("Invalid or unsupported selector syntax.");case 5:if(h.match(validNameNonInitialChar)){f.attrValue+=h;break}if("."==h){c();f.attrName="class";f.contains=!0;l=4;break}if("#"==h){c();
f.attrName="id";l=4;break}if("["==h){c();l=6;break}if(h.match(k)){l=14;break}if(","==h){l=1;break}throw Error("Invalid or unsupported selector syntax.");case 6:if(h.match(validNameInitialChar)){f.attrName=h;l=7;break}if(h.match(k))break;throw Error("Invalid or unsupported selector syntax.");case 7:if(h.match(validNameNonInitialChar)){f.attrName+=h;break}if(h.match(k)){l=8;break}if("~"==h){f.contains=!0;l=9;break}if("="==h){f.attrValue="";l=11;break}if("]"==h){l=3;break}throw Error("Invalid or unsupported selector syntax.");
case 8:if("~"==h){f.contains=!0;l=9;break}if("="==h){f.attrValue="";l=11;break}if("]"==h){l=3;break}if(h.match(k))break;throw Error("Invalid or unsupported selector syntax.");case 9:if("="==h){f.attrValue="";l=11;break}throw Error("Invalid or unsupported selector syntax.");case 10:if("]"==h){l=3;break}if(h.match(k))break;throw Error("Invalid or unsupported selector syntax.");case 11:if(h.match(k))break;if('"'==h||"'"==h){m=h;l=13;break}f.attrValue+=h;l=12;break;case 12:if(h.match(k)){l=10;break}if("]"==
h){l=3;break}if("'"==h||'"'==h)throw Error("Invalid or unsupported selector syntax.");f.attrValue+=h;break;case 13:if(h==m){l=10;break}f.attrValue+=h;break;case 14:if(h.match(k))break;if(","==h){l=1;break}throw Error("Invalid or unsupported selector syntax.");}}switch(l){case 1:case 2:case 3:case 5:case 14:e();break;default:throw Error("Invalid or unsupported selector syntax.");}if(!d.length)throw Error("Invalid or unsupported selector syntax.");return d};b.nextUid=1;b.matchesSelector=function(){var a=
document.createElement("div");return"function"===typeof a.webkitMatchesSelector?"webkitMatchesSelector":"function"===typeof a.mozMatchesSelector?"mozMatchesSelector":"function"===typeof a.msMatchesSelector?"msMatchesSelector":"matchesSelector"}();return b}(),attributeFilterPattern=/^([a-zA-Z:_]+[a-zA-Z0-9_\-:\.]*)$/;
function validateAttribute(b){if("string"!=typeof b)throw Error("Invalid request opion. attribute must be a non-zero length string.");b=b.trim();if(!b)throw Error("Invalid request opion. attribute must be a non-zero length string.");if(!b.match(attributeFilterPattern))throw Error("Invalid request option. invalid attribute name: "+b);return b}
function validateElementAttributes(b){if(!b.trim().length)throw Error("Invalid request option: elementAttributes must contain at least one attribute.");var a={},e={};b=b.split(/\s+/);for(var c=0;c<b.length;c++){var d=b[c];if(d){var d=validateAttribute(d),g=d.toLowerCase();if(a[g])throw Error("Invalid request option: observing multiple case variations of the same attribute is not supported.");e[d]=!0;a[g]=!0}}return Object.keys(e)}
function elementFilterAttributes(b){var a={};b.forEach(function(b){b.qualifiers.forEach(function(b){a[b.attrName]=!0})});return Object.keys(a)}
var MutationSummary=function(){function b(a){var e=this;this.connected=!1;this.options=b.validateOptions(a);this.observerOptions=b.createObserverOptions(this.options.queries);this.root=this.options.rootNode;this.callback=this.options.callback;this.elementFilter=Array.prototype.concat.apply([],this.options.queries.map(function(a){return a.elementFilter?a.elementFilter:[]}));this.elementFilter.length||(this.elementFilter=void 0);this.calcReordered=this.options.queries.some(function(a){return a.all});
this.queryValidators=[];b.createQueryValidator&&(this.queryValidators=this.options.queries.map(function(a){return b.createQueryValidator(e.root,a)}));this.observer=new MutationObserverCtor(function(a){e.observerCallback(a)});this.reconnect()}b.createObserverOptions=function(a){function b(a){if(!c.attributes||d)c.attributes=!0,c.attributeOldValue=!0,a?(d=d||{},a.forEach(function(a){d[a]=!0;d[a.toLowerCase()]=!0})):d=void 0}var c={childList:!0,subtree:!0},d;a.forEach(function(a){a.characterData?(c.characterData=
!0,c.characterDataOldValue=!0):a.all?(b(),c.characterData=!0,c.characterDataOldValue=!0):a.attribute?b([a.attribute.trim()]):(a=elementFilterAttributes(a.elementFilter).concat(a.attributeList||[]),a.length&&b(a))});d&&(c.attributeFilter=Object.keys(d));return c};b.validateOptions=function(a){for(var e in a)if(!(e in b.optionKeys))throw Error("Invalid option: "+e);if("function"!==typeof a.callback)throw Error("Invalid options: callback is required and must be a function");if(!a.queries||!a.queries.length)throw Error("Invalid options: queries must contain at least one query request object.");
e={callback:a.callback,rootNode:a.rootNode||document,observeOwnChanges:!!a.observeOwnChanges,oldPreviousSibling:!!a.oldPreviousSibling,queries:[]};for(var c=0;c<a.queries.length;c++){var d=a.queries[c];if(d.all){if(1<Object.keys(d).length)throw Error("Invalid request option. all has no options.");e.queries.push({all:!0})}else if("attribute"in d){var g={attribute:validateAttribute(d.attribute)};g.elementFilter=Selector.parseSelectors("*["+g.attribute+"]");if(1<Object.keys(d).length)throw Error("Invalid request option. attribute has no options.");
e.queries.push(g)}else if("element"in d){var f=Object.keys(d).length,g={element:d.element,elementFilter:Selector.parseSelectors(d.element)};d.hasOwnProperty("elementAttributes")&&(g.attributeList=validateElementAttributes(d.elementAttributes),f--);if(1<f)throw Error("Invalid request option. element only allows elementAttributes option.");e.queries.push(g)}else if(d.characterData){if(1<Object.keys(d).length)throw Error("Invalid request option. characterData has no options.");e.queries.push({characterData:!0})}else throw Error("Invalid request option. Unknown query request.");
}return e};b.prototype.createSummaries=function(a){if(!a||!a.length)return[];a=new MutationProjection(this.root,a,this.elementFilter,this.calcReordered,this.options.oldPreviousSibling);for(var b=[],c=0;c<this.options.queries.length;c++)b.push(new Summary(a,this.options.queries[c]));return b};b.prototype.checkpointQueryValidators=function(){this.queryValidators.forEach(function(a){a&&a.recordPreviousState()})};b.prototype.runQueryValidators=function(a){this.queryValidators.forEach(function(b,c){b&&
b.validate(a[c])})};b.prototype.changesToReport=function(a){return a.some(function(a){return"added removed reordered reparented valueChanged characterDataChanged".split(" ").some(function(b){return a[b]&&a[b].length})||a.attributeChanged&&Object.keys(a.attributeChanged).some(function(b){return!!a.attributeChanged[b].length})?!0:!1})};b.prototype.observerCallback=function(a){this.options.observeOwnChanges||this.observer.disconnect();a=this.createSummaries(a);this.runQueryValidators(a);this.options.observeOwnChanges&&
this.checkpointQueryValidators();this.changesToReport(a)&&this.callback(a);!this.options.observeOwnChanges&&this.connected&&(this.checkpointQueryValidators(),this.observer.observe(this.root,this.observerOptions))};b.prototype.reconnect=function(){if(this.connected)throw Error("Already connected");this.observer.observe(this.root,this.observerOptions);this.connected=!0;this.checkpointQueryValidators()};b.prototype.takeSummaries=function(){if(!this.connected)throw Error("Not connected");var a=this.createSummaries(this.observer.takeRecords());
return this.changesToReport(a)?a:void 0};b.prototype.disconnect=function(){var a=this.takeSummaries();this.observer.disconnect();this.connected=!1;return a};b.NodeMap=NodeMap;b.parseElementFilter=Selector.parseSelectors;b.optionKeys={callback:!0,queries:!0,rootNode:!0,oldPreviousSibling:!0,observeOwnChanges:!0};return b}(),TreeMirrorClient=function(){function b(a,b,c){var d=this;this.target=a;this.mirror=b;this.nextId=1;this.knownNodes=new MutationSummary.NodeMap;b=this.serializeNode(a).i;for(var g=
[],f=a.firstChild;f;f=f.nextSibling)g.push(this.serializeNode(f,!0));this.mirror.initialize(b,g);b=[{all:!0}];c&&(b=b.concat(c));this.mutationSummary=new MutationSummary({rootNode:a,callback:function(a){d.applyChanged(a)},queries:b})}b.prototype.reconnect=function(){this.mutationSummary.reconnect()};b.prototype.disconnect=function(){this.mutationSummary&&(this.mutationSummary.disconnect(),this.mutationSummary=void 0)};b.prototype.rememberNode=function(a){var b=this.nextId++;this.knownNodes.set(a,
b);return b};b.prototype.forgetNode=function(a){this.knownNodes["delete"](a)};b.prototype.serializeNode=function(a,b){if(null===a)return null;var c=this.knownNodes.get(a);if(void 0!==c)return{i:c};c={n:a.nodeType,i:this.rememberNode(a)};switch(c.n){case Node.DOCUMENT_TYPE_NODE:c.name=a.name;c.publicId=a.publicId;c.systemId=a.systemId;break;case Node.COMMENT_NODE:case Node.TEXT_NODE:if(a.parentElement&&a.parentElement.getAttribute("type")&&"string"==typeof a.parentElement.getAttribute("type")&&"textarea"==
a.parentElement.getAttribute("type").toLowerCase()){for(var d="",g=0;g<a.textContent.length;g++)d+="*";c.t=d}else if(g=d="","string"==(typeof a.className).toLowerCase()&&(d=a.className.toLowerCase()),a.parentElement&&"string"==(typeof a.parentElement.className).toLowerCase()&&(g=a.parentElement.className.toLowerCase()),-1<d.indexOf("losensitive")||-1<g.indexOf("losensitive")){d="";for(g=0;g<a.textContent.length;g++)d+="*";c.t=d}else c.t=a.textContent;break;case Node.ELEMENT_NODE:c.g=a.tagName;c.a=
{};d=!1;g="";a&&a.nodeName&&(g=a.nodeName.toLowerCase());if("script"==g)break;else if("input"==g||"textarea"==g)if(d=!0,"input"==g&&a.type&&(g=a.type.toLowerCase(),"submit"==g||"button"==g))d=!1;for(g=0;g<a.attributes.length;g++){var f=a.attributes[g];d&&f.name&&"value"==f.name.toLowerCase()?c.a[f.name]="":c.a[f.name]=f.value}if(b&&a.childNodes.length)for(c.c=[],d=a.firstChild;d;d=d.nextSibling)c.c.push(this.serializeNode(d,!0))}return c};b.prototype.serializeAddedAndMoved=function(a,b,c){var d=this;
a=a.concat(b).concat(c);var g=new MutationSummary.NodeMap;a.forEach(function(a){var b=a.parentNode,c=g.get(b);c||(c=new MutationSummary.NodeMap,g.set(b,c));c.set(a,!0)});var f=[];g.keys().forEach(function(a){a=g.get(a);for(var b=a.keys();b.length;){for(b=b[0];b.previousSibling&&a.has(b.previousSibling);)b=b.previousSibling;for(;b&&a.has(b);){var c=d.serializeNode(b);c.previousSibling=d.serializeNode(b.previousSibling);c.parentNode=d.serializeNode(b.parentNode);f.push(c);a["delete"](b);b=b.nextSibling}b=
a.keys()}});return f};b.prototype.serializeAttributeChanges=function(a){var b=this,c=new MutationSummary.NodeMap;Object.keys(a).forEach(function(d){a[d].forEach(function(a){var f=c.get(a);f||(f=b.serializeNode(a),f.attributes={},c.set(a,f));f.attributes[d]=a.getAttribute(d)})});return c.keys().map(function(a){return c.get(a)})};b.prototype.applyChanged=function(a){var b=this;a=a[0];var c=a.removed.map(function(a){return b.serializeNode(a)}),d=this.serializeAddedAndMoved(a.added,a.reparented,a.reordered),
g=this.serializeAttributeChanges(a.attributeChanged),f=a.characterDataChanged.map(function(a){var c=b.serializeNode(a);c.textContent=a.textContent;return c});this.mirror.applyChanged(c,d,g,f);a.removed.forEach(function(a){b.forgetNode(a)})};return b}();